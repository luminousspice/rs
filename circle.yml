general:
  branches:
    ignore:
      - gh-pages

checkout:
  post:
    - git submodule sync
    - git submodule update --init --recursive

machine:
  timezone: Asia/Tokyo
  ruby:
    version: 2.2.3

dependencies:
  pre:
    - wget https://github.com/spf13/hugo/releases/download/v0.20/hugo_0.20_i386.deb
    - sudo dpkg -i hugo_0.20_i386.deb
    - git config --global user.name "CircleCI"
    - git config --global user.email "circleci@example.com"
  override:
    # http://stackoverflow.com/a/31032379
    - bundle check --path=vendor/bundle || bundle install --path=vendor/bundle --jobs=4 --retry=3
    - gem install asciidoctor

test:
  post:
    - hugo version
    - hugo #--baseURL="/"
    - bundle exec htmlproof ./public --only-4xx --href-ignore '/anki.tenderapp.com/','/ankiweb.net/','/la.ma.la/','/apple.com/','/rs.luminousspice.com/' --alt-ignore '/.*/' --file-ignore /.*vendor\/bundle*/ --external_only
    - rm -rf public

deployment:
  master:
    branch: dev
    commands:
      - git clone --depth=1 -b gh-pages git@github.com:luminousspice/rs.git public
      - cd public && rm -rf * && git rm -rf .
      - hugo
      - cd public && git add -A
      - cd public && git commit -m "[ci skip] publish build ${CIRCLE_BUILD_NUM} (${CIRCLE_SHA1})"
      - cd public && git push origin gh-pages
