<!DOCTYPE html>
<html class="no-js" lang="ja" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
<meta name="description" content='復習で熟知になったカードのノートにタグを付けるアドオンを作る Anki アドオン作成のチュートリアルです。Anki の標準フックがない場所にカスタムのフックを設置する方法にも触れます。最後にアドオンを AnkiWeb に公開する手順を紹介します。'>
<meta name="keywords" content="Anki, Python, 開発, アドオン, フック">

<meta property="og:type" content="article" />
<meta property="og:description" content='復習で熟知になったカードのノートにタグを付けるアドオンを作る Anki アドオン作成のチュートリアルです。Anki の標準フックがない場所にカスタムのフックを設置する方法にも触れます。最後にアドオンを AnkiWeb に公開する手順を紹介します。'/>
<meta property="og:title" content="フックを使った Anki アドオンのつくり方" />
<meta property="og:site_name" content="the Right Stuff" />
<meta property="og:url" content="http://rs.luminousspice.com/how_to_create_anki_add-ons/">
<meta property="og:locale" content="ja">
<meta property="og:image" content="http://rs.luminousspice.com/apple-touch-icon.png" />

<meta property="article:published_time" content="2014-01-17T22:55:53Z"/>
<meta property="article:modified_time" content="2016-05-30T23:54:07Z"/>



<meta property="article:tag" content="Anki"><meta property="article:tag" content="Python"><meta property="article:tag" content="開発"><meta property="article:tag" content="アドオン"><meta property="article:tag" content="フック">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@luminousspice">
<meta name="twitter:title" content="フックを使った Anki アドオンのつくり方">
<meta name="twitter:creator" content="@luminousspice">
<meta name="twitter:description" content='復習で熟知になったカードのノートにタグを付けるアドオンを作る Anki アドオン作成のチュートリアルです。Anki の標準フックがない場所にカスタムのフックを設置する方法にも触れます。最後にアドオンを AnkiWeb に公開する手順を紹介します。'>
<meta name="twitter:image:src" content="http://rs.luminousspice.com/apple-touch-icon.png">
<meta name="twitter:domain" content="luminousspice.com">

  <base href="http://rs.luminousspice.com">
  <title>フックを使った Anki アドオンのつくり方 | the right stuff</title>

  <link rel="stylesheet" href="http://rs.luminousspice.com/css/rs.css">

  <link rel="apple-touch-icon" href="http://rs.luminousspice.com/apple-touch-icon.png">
  <link rel="shortcut icon" href="http://rs.luminousspice.com/favicon.ico" type="image/x-icon">
  
  <link rel="canonical" href="http://rs.luminousspice.com/how_to_create_anki_add-ons/">
  <link href="http://rs.luminousspice.com/index.xml" rel="alternate" type="application/rss+xml" title="the Right Stuff" />
  <link href="http://rs.luminousspice.com/index.xml" rel="feed" type="application/rss+xml" title="the Right Stuff" />
</head>


  <body>

    
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    このコンテンツは @luminousspice が非同期的に更新しています。経時的な順序に意味はありません。
  </div>

  <nav class="sidebar-nav">
    
    <a class="sidebar-nav-item " href="http://rs.luminousspice.com/table-of-contents/">総目次</a>
    <a class="sidebar-nav-item " href="http://rs.luminousspice.com/index-how-to-anki/">Anki 索引</a>
    <a class="sidebar-nav-item " href="http://rs.luminousspice.com/post/">アーカイブ</a>
    <a class="sidebar-nav-item " href="http://rs.luminousspice.com/search/">全文検索</a>
    
    <a class="sidebar-nav-item" href="https://github.com/luminousspice">GitHub project</a>
  </nav>

  <div class="sidebar-item">
  </div>
</div>


    
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="http://rs.luminousspice.com/" title="Home">the Right Stuff</a>
            <small></small>
          </h3>
        </div>
      </div>

      <div class="container content">


<div class="post">
  <h1 class="post-title">フックを使った Anki アドオンのつくり方</h1>
  <span class="post-date"><time datetime="2014-01-17T22:55:53Z"></time>2016-05-30 更新</span>
  <nav class="toc">
    <div id="toc"></div>
  </nav>
  <div class="post-content">
  <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>復習で熟知になったカードのノートにタグを付けるアドオンを作る Anki アドオン作成のチュートリアルです。Anki の標準フックがない場所にカスタムのフックを設置する方法にも触れます。最後にアドオンを AnkiWeb に公開する手順を紹介します。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_はじめに">はじめに</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Anki は、アドオンを作成することで、標準機能を拡張したり、変更したりすることが出来ます。このアドオンの作成を簡単にするために、Anki はフック (Hook) という機能を提供しています。フックを使うと標準機能の中に簡単に外部の関数を組み込むことが出来ます。</p>
</div>
<div class="paragraph">
<p>この記事では更に進んで Anki の標準のフックがない場所にカスタムのフックを追加し、機能拡張するアドオンを作成する方法を簡単に説明します。復習後、熟知になったカードのノートにタグを付けるアドオンを開発します。オフィシャルドキュメント「<a href="http://rs.luminousspice.com/anki2addons/">Anki 2.0 アドオンの作成</a>」を補足する内容です。</p>
</div>
<div class="paragraph">
<p>AnkiWeb に公開済みの Аnki アドオン (Add-on) <a href="https://ankiweb.net/shared/info/17741639">Mature Tag</a> (Code: <code>17741639</code>) を例にとって解説します。</p>
</div>
<div class="paragraph">
<p>完成品をインストールして動作させることが出来ますし、ソースコードを見ることも出来ます。最後に作成したアドオンを AnkiWeb の共有アドオン一覧に登録する方法を紹介します。</p>
</div>
<div class="paragraph">
<p>アドオンのインストール方法は、<a href="http://rs.luminousspice.com/how-to-use-shared-resources/">Ankiの共有リソースを使ってみる</a>で紹介しています。</p>
</div>
<div class="paragraph">
<p>また、ソースコードの表示方法は、インストールが完了した後、メニューバーの[ツール]-[アドオン]-[Mature_Tag]-[編集&#8230;&#8203;]を選択してください。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_前提知識">前提知識</h2>
<div class="sectionbody">
<div class="paragraph">
<p>この記事の内容を理解するには、次の知識が必要です。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Anki の操作方法
特に、Anki というアプリケーションの機能を十分理解した上での操作方法の習熟は必須です。</p>
</li>
<li>
<p>Python による開発経験
他の開発言語の経験でも構いませんが、自分で資料を読み Python の開発方法を学べる能力は必要です。</p>
</li>
<li>
<p><a href="http://rs.luminousspice.com/anki2addons/">Anki 2.0 アドオンの作成</a>の内容理解
本文中のサンプルコードを実際に動かしてアドオンを作成する経験があると理解に役立ちます。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>この記事の最後に <a href="http://rs.luminousspice.com/how_to_create_anki_add-ons/#review">Anki アドオン開発のおさらい</a> という項目を設けて、必要な知識をまとめています。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_つくるアドオンの要件">つくるアドオンの要件</h2>
<div class="sectionbody">
<div class="paragraph">
<p>まず最初にアドオンの要件を決めておきます。</p>
</div>
<div class="paragraph">
<p>「復習が終わったら、新たに設定した復習間隔を調べ、熟知なら "Mature" というタグをノートに追加し、それ以外なら  "Mature" を削除します。」</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_モジュールのインポート">モジュールのインポート</h2>
<div class="sectionbody">
<div class="paragraph">
<p>最初に必要なモジュールをインポートします。
Anki の復習で解答した時の処理は <a href="https://github.com/dae/anki/blob/master/anki/sched.py">sched.py</a> の中のクラス <code>Scheduler</code> のメソッド <code>answerCard</code> で記述しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">from anki.sched import Scheduler</code></pre>
</div>
</div>
<div class="paragraph">
<p>残念ながら復習に関する処理の中にフック (Hook) は存在しません。
そこで独自のフックをこのメソッドの最後に追加します。
フックの設置、呼び出しに必要なモジュールをインポートします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">from anki.hooks import addHook, runHook, wrap</code></pre>
</div>
</div>
<div class="paragraph">
<p>フックを設置すると、複数の関数がそのの場所で実行できるようになります。
今回の例のように一つの関数しか実行しないのであれば、<code>wrap()</code> 関数だけを利用して単純に書くこともできます。その<a href="http://rs.luminousspice.com/how_to_create_anki_add-ons/#wrap">書き換え例</a>は完成品の後に示します。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_復習の解答後に処理するフックを設置する">復習の解答後に処理するフックを設置する</h2>
<div class="sectionbody">
<div class="paragraph">
<p></p>
</div>
<div class="paragraph">
<p>まず、独自のフック "answeredRevCard" を追加する関数 <code>newAnswerCard()</code> を定義します。
runHook() はフックを新たに設置する標準の関数です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def newAnswerCard(self, card, ease):
    runHook('answeredRevCard', self, card)</code></pre>
</div>
</div>
<div class="paragraph">
<p>次に標準の <code>wrap()</code> 関数を使って、<code>answerCard</code> の後に <code>newAnswerCard</code> の内容を追加する処理を記述します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">Scheduler.answerCard = wrap(Scheduler.answerCard, newAnswerCard)</code></pre>
</div>
</div>
<div class="paragraph">
<p>すると <code>answerCard</code> の最後に次の行が追加されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">runHook('answeredRevCard', self, card)</code></pre>
</div>
</div>
<div class="paragraph">
<p>これで、復習で解凍した後に処理を呼び出すフックを設置できました。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_タグを追加_削除する">タグを追加、削除する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>復習が終わったら、復習間隔を調べ 21 日以上であったら、"Mature" タグを追加し、それ以外の場合は削除する関数　<code>matureCheck()</code> を定義します。
熟知の基準日数は変数 <code>threshold</code> に、設定するタグ文字列は変数 <code>MatureTag</code> に設定しました。
タグをノートに追加するには <code>Note</code> クラスのメソッド <code>addTag()</code> を、削除するには <code>delTag()</code> を使います。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python"># Threshold interval for tagging
threshold = 21
# Tag string for mature note
MatureTag = u"Mature"

def matureCheck(self, card):
    f = card.note()
    if (card.ivl &gt;= threshold):
        f.addTag(MatureTag)
    else:
        f.delTag(MatureTag)
    f.flush()
    return True</code></pre>
</div>
</div>
<div class="paragraph">
<p>最後に <code>addHook()</code> 関数を使って上で作成したカスタムフック "answeredRevCard"　で <code>matureCheck()</code> 関数を呼び出す設定をします。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">addHook("answeredRevCard", matureCheck)</code></pre>
</div>
</div>
<div class="paragraph">
<p>これで、完成です。完成品は次の通りです。</p>
</div>
<div class="listingblock">
<div class="title">Mature_Tag.py</div>
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">from anki.hooks import addHook, runHook, wrap
from anki.sched import Scheduler

# Threshold interval for tagging
threshold = 21
# Tag string for mature note
MatureTag = u"Mature"

def matureCheck(self, card):
    f = card.note()
    if (card.ivl &gt;= threshold):
        f.addTag(MatureTag)
    else:
        f.delTag(MatureTag)
    f.flush()
    return True

def newAnswerCard(self, card, ease):
    runHook('answeredRevCard', self, card)

Scheduler.answerCard = wrap(Scheduler.answerCard, newAnswerCard)

addHook("answeredRevCard", matureCheck)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="wrap">もっとかんたんに書く</h2>
<div class="sectionbody">
<div class="paragraph">
<p>フックを設置せずに <code>wrap()</code> 関数を使う方法を紹介しましょう。直接 <code>matureCheck</code> を指定します。</p>
</div>
<div class="listingblock">
<div class="title">変更箇所の差分表示　(- で始まる行を削除、+ で始まる行を追加)</div>
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">@@ -1,4 +1,4 @@
-from anki.hooks import addHook, runHook, wrap
+from anki.hooks import wrap
 from anki.sched import Scheduler

 # Threshold interval for tagging
@@ -6,7 +6,7 @@
 # Tag string for mature note
 MatureTag = u"Mature"

-def matureCheck(self, card):
+def matureCheck(self, card, ease):
     f = card.note()
     if (card.ivl &gt;= threshold):
         f.addTag(MatureTag)
@@ -15,9 +15,4 @@
     f.flush()
     return True

-def newAnswerCard(self, card, ease):
-    runHook('anseweredRevCard', self, card)
-
-Scheduler.answerCard = wrap(Scheduler.answerCard, newAnswerCard)
-
-addHook("anseweredRevCard", matureCheck)
+Scheduler.answerCard = wrap(Scheduler.answerCard, matureCheck)</code></pre>
</div>
</div>
<div class="paragraph">
<p>AnkiWeb に公開済みの Аnki アドオン (Add-on) <a href="https://ankiweb.net/shared/info/17741639">Mature Tag</a> (Code: <code>17741639</code>) は、この簡略版を公開しています。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ファイルの配置">ファイルの配置</h2>
<div class="sectionbody">
<div class="paragraph">
<p>完成したファイル Mature_Tag.py を動作させるには、<code>Documents/Anki/addons</code> フォルダの中に保存します。Anki を再起動すると、この Python スクリプトファイルを読み込みます。</p>
</div>
<div class="paragraph">
<p>アドオンが読み込まれるとメニューバーに [ツール]-[アドオン]-[Mature_Tag] という項目が追加されます。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ankiweb_の共有アドオン一覧に登録する">AnkiWeb の共有アドオン一覧に登録する</h2>
<div class="sectionbody">
<div class="paragraph">
<p>作成したアドオンを AnkiWeb に公開して、アドオン一覧に登録する方法を紹介します。
まず、<a href="https://ankiweb.net/shared/addons/">共有アドオン一覧</a>を開き、AnkiWeb にサインインします。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="http://rs.luminousspice.com/images/anki_addon_tutorial_1.png" alt="アドオン一覧" width="60%">
</div>
<div class="title">図 1. 共有アドオン一覧</div>
</div>
<div class="paragraph">
<p>登録フォームは画面右上の [Upload Add-on] ボタンをクリックすると表示します。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="http://rs.luminousspice.com/images/anki_addon_tutorial_2.png" alt="登録フォーム" width="60%">
</div>
<div class="title">図 2. アドオン登録フォーム</div>
</div>
<div class="paragraph">
<p>このフォームでは次のように項目入力します。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Title:</strong> アドオンの名前を入力します。アドオン一覧に表示する名前にになります。</p>
</li>
<li>
<p><strong>File:</strong> 登録したいアドオンの Python スクリプトを選択します。今回の例では <code>Mature_Tag.py</code> です。</p>
</li>
<li>
<p><strong>Description</strong> アドオンユーザーのためにアドオンの機能や使い方の説明を入力します。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>入力が済んだら [Upload] を押すと登録できます。特に AnkiWeb に障害がなければ即座に公開されます。
登録したアドオンのページに移動します。</p>
</div>
<div class="paragraph">
<p>公開したアドオンのページの下にある [Update] ボタンを押すと登録内容の編集ができ、[Remove] ボタンを押すとアドオンを削除することができます。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="http://rs.luminousspice.com/images/anki_addon_tutorial_3.png" alt="アドオンページ 編集、削除ボタン">
</div>
<div class="title">図 3. アドオンページ 編集、削除ボタン</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_まとめ">まとめ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>「Anki 2.0 アドオンの作成」で説明しているとおり、Anki が標準で用意しているフックを利用すると Anki の機能の修正や追加が簡単になります。フックが用意されていない箇所にも、この記事で紹介した方法で自分でカスタムのフックを自由に追加することができます。フックの使い方になれると Anki アドオン作成するを能力が向上し、Anki 自身の機能についても理解を深めることができます。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="review">遺補: Anki アドオン開発のおさらい</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Anki のアドオンは、Python スクリプトで記述し、<code>Documents/Anki/addons</code> フォルダの中に保存します。
Anki に Python インタープリタが含まれているため、アドオンの開発に Python のインストールは必要ありません。</p>
</div>
<div class="paragraph">
<p>Anki は起動時に <code>addons</code> フォルダの中の <code>.py</code> ファイルを読み込みます。
従って、新たにアドオンファイルを追加した場合、再起動して初めて機能するようになります。
なお、シフトキーを押したまま Anki を起動すると、アドオンファイルの読み込みは行いません。</p>
</div>
<div class="paragraph">
<p>Anki には、WordPress のようにフック (Hook) という機能を提供していて、標準機能を拡張したり、変更したりするアドオン開発が容易に出来ます。Anki 自身もたくさんのフックを利用しています。</p>
</div>
<div class="paragraph">
<p>アドオンをつくるために Anki が用意している関数は次の通りです。</p>
</div>
<table class="tableblock frame-topbot grid-rows spread">
<caption class="title">表 1. アドオン開発用関数</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">関数名</th>
<th class="tableblock halign-left valign-top">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">runHook</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">フックを実行する。値は返さない。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">runFilter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">フィルターを実行し値を返す。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">addHook</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">フックを追加する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">remHook</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">フックを削除する。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wrap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">既存の関数を上書きする。第3引数でオリジナルの関数の位置を指定。既定はオリジナルの後にカスタム関数を実行する。</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>フックを見つけるには、Anki のソースコードを　"runHook"、"runFilter" で検索します。Anki 2.0.36 現在 49 のフックが存在します。</p>
</div>
<div class="paragraph">
<p>フックの使い方を詳しく知るには、<a href="http://rs.luminousspice.com/anki2addons/">Anki 2.0 アドオンの作成</a>、および <a href="https://github.com/dae/anki/blob/master/anki/hooks.py">anki/hooks.py</a> をお読みください。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_更新情報">更新情報</h2>
<div class="sectionbody">
<div class="paragraph">
<p>2014/01/17: 初出<br>
2016/05/04: 更新: サンプルファイルの保存場所を変更<br>
2016/05/31: 更新: カスタムフックを設置しない方法について加筆<br></p>
</div>
</div>
</div>

  </div>
  <aside class="reference">
  
  
  </aside>
</div>

      <footer>
        <div class="footer">
          &copy; 2017 luminousspice.com.
        </div>
      </footer>
      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

<script>
var addtoc = function() {

  var threshold = 5;
  var toc = document.getElementById('toc');      
  var widget = document.querySelector('.toc');   
  var pre1 = document.querySelector('.sect1');   
  var pre2 = document.querySelector('#preamble');
  var headings = document.querySelectorAll('.post-content h2');
  if (!toc || !widget) {
    return;
  }
  if (headings.length < threshold) {
    return;
  }

  list = [];
  list.push('<div class="toc-title">この記事の内容</div><ol>');

    for (var i=0; i < headings.length; i++) {
      var h = headings[i];
      var d = document.createElement('a');
      var aname = 'i-' + i;
      d.name = aname;
      h.parentNode.insertBefore(d, h);
      var s = '<li><a href="http:\/\/rs.luminousspice.com\/how_to_create_anki_add-ons\/#' + aname + '">' + h.innerHTML + '</a></li>';
      list.push(s);
    }

  list.push('</ol>');
  toc.innerHTML = list.join("");
 
  if (pre2){
    pre2.appendChild(widget);
  } else {
    pre1.parentNode.insertBefore(widget, pre1); 
   }
}

addtoc();
</script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-29141274-4', 'auto');
ga('send', 'pageview');
</script>



  </body>
</html>
