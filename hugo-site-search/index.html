<!DOCTYPE html>
<html class="no-js" lang="ja" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
<meta name="description" content='静的サイトジェネレータ Hugo を使って生成したコンテンツに 全文検索を取り付けました。Hugo からコンテンツと一緒にインデックスファイルも同時に書き出し、クライアント側の JavaScript で日本語のキーワードを検索をします。'>
<meta name="keywords" content="開発, JavaScript, 検索">

<meta property="og:type" content="article" />
<meta property="og:description" content='静的サイトジェネレータ Hugo を使って生成したコンテンツに 全文検索を取り付けました。Hugo からコンテンツと一緒にインデックスファイルも同時に書き出し、クライアント側の JavaScript で日本語のキーワードを検索をします。'/>
<meta property="og:title" content="Hugo に全文検索を取り付けた" />
<meta property="og:site_name" content="the Right Stuff" />
<meta property="og:url" content="http://rs.luminousspice.com/hugo-site-search/">
<meta property="og:locale" content="ja">
<meta property="og:image" content="http://rs.luminousspice.com/apple-touch-icon.png" />

<meta property="article:published_time" content="2016-04-01T21:27:23&#43;09:00"/>
<meta property="article:modified_time" content="2016-04-02T01:57:48&#43;09:00"/>



<meta property="article:tag" content="開発"><meta property="article:tag" content="JavaScript"><meta property="article:tag" content="検索">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@luminousspice">
<meta name="twitter:title" content="Hugo に全文検索を取り付けた">
<meta name="twitter:creator" content="@luminousspice">
<meta name="twitter:description" content='静的サイトジェネレータ Hugo を使って生成したコンテンツに 全文検索を取り付けました。Hugo からコンテンツと一緒にインデックスファイルも同時に書き出し、クライアント側の JavaScript で日本語のキーワードを検索をします。'>
<meta name="twitter:image:src" content="http://rs.luminousspice.com/apple-touch-icon.png">
<meta name="twitter:domain" content="luminousspice.com">

  <base href="http://rs.luminousspice.com/hugo-site-search/">
  <title>Hugo に全文検索を取り付けた | the right stuff</title>

  <link rel="stylesheet" href="http://rs.luminousspice.com/css/rs.css">

  <link rel="apple-touch-icon" href="http://rs.luminousspice.com/apple-touch-icon.png">
  <link rel="shortcut icon" href="http://rs.luminousspice.com/favicon.ico" type="image/x-icon">
  
  <link rel="canonical" href="http://rs.luminousspice.com/hugo-site-search/">
  <link href="http://rs.luminousspice.com/index.xml" rel="alternate" type="application/rss+xml" title="the Right Stuff" />
  <link href="http://rs.luminousspice.com/index.xml" rel="feed" type="application/rss+xml" title="the Right Stuff" />
</head>


  <body>

    
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">


<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    このコンテンツは @luminousspice が非同期的に更新しています。経時的な順序に意味はありません。
  </div>

  <nav class="sidebar-nav">
    
    <a class="sidebar-nav-item " href="http://rs.luminousspice.com/table-of-contents/">総目次</a>
    <a class="sidebar-nav-item " href="http://rs.luminousspice.com/index-how-to-anki/">Anki 索引</a>
    <a class="sidebar-nav-item " href="http://rs.luminousspice.com/post/">アーカイブ</a>
    <a class="sidebar-nav-item " href="http://rs.luminousspice.com/search/">全文検索</a>
    
    <a class="sidebar-nav-item" href="https://github.com/luminousspice">GitHub project</a>
  </nav>

  <div class="sidebar-item">
  </div>
</div>


    
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="http://rs.luminousspice.com/" title="Home">the Right Stuff</a>
            <small></small>
          </h3>
        </div>
      </div>

      <div class="container content">


<div class="post">
  <h1 class="post-title">Hugo に全文検索を取り付けた</h1>
  <span class="post-date"><time datetime="2016-04-01T21:27:23&#43;09:00"></time>2016-04-02 更新</span>
  <nav class="toc">
    <div id="toc"></div>
  </nav>
  <aside class="notice">
  

  </aside>
  <div class="post-content">
  <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>静的サイトジェネレータ Hugo を使って生成したコンテンツに 全文検索を取り付けました。Hugo でのコンテンツと一緒にインデックスファイルも同時に書き出し、クライアント側の JavaScript で日本語のキーワードを検索をします。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_はじめに">はじめに</h2>
<div class="sectionbody">
<div class="paragraph">
<p>この件は、ゼロベースから考えました。</p>
</div>
<div class="paragraph">
<p>ちょうど WordPress で運用していたデータを静的ジェネレータ (SSG) の <a href="http://gohugo.io">Hugo</a> に移行し、CI を使って GitHub Pages 上に展開したところです。</p>
</div>
<div class="paragraph">
<p>最低限の CSS だけのテンプレートを使って静的なページを作っているので、JavaScript を使うにしても出来る限り絞り込みたいというのが、前提条件でした。</p>
</div>
<div class="paragraph">
<p>元原稿は AsciiDoc の集まりなので、そこからインデックスファイルを作り、このファイルを JavaScript で検索するページを作ればよいだろうとザックリと考えました。サイトのコンテンツの規模は、1.2MB、70 ファイルです。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_javascript_で全文検索">JavaScript で全文検索</h2>
<div class="sectionbody">
<div class="paragraph">
<p>JavaScript の日本語の全文検索について調べていたところ、 <a href="http://la.ma.la/search.html">JavaScriptにBlogの全文検索をやらせてみるテスト</a> を見つけました。事前にインデックスファイルを JavaScript のオプジェクトとして保存し、クライアント側で検索する作りになっています。
高速に検索し、使い勝手が気に入りました。これを自分の Hugo のコンテンツと一緒に使えないかと考えました。なお、再利用と改変について作者ご本人から直接承諾を得ました。</p>
</div>
<div class="paragraph">
<p>このサイトでも、派生系のスクリプトでも、インデックスを生成するためのスクリプトを別途走らせています。この部分もSSG にやらせたいと考えました。ページを生成するのも、インデックスファイルを生成するのも大差ないのですから。</p>
</div>
<div class="paragraph">
<p><strong>参考:</strong> <a href="http://la.ma.la/blog/diary_200506252348.htm">最速インターフェース研究会 JavaScriptにBlogの全文検索をやらせてみる</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_インデックスファイルの生成">インデックスファイルの生成</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hugo に全文検索用のインデックスファイルを書き出させるには、ちょっとしたコツが必要です。Hugo のコミュニティサイトから学びました。それは、インデックスファイル <code>index.js</code> を書き出すための特別な Type のテンプレートを作成し、ダミーの投稿と使って書き出すというものです。素晴らしいアイデアです。</p>
</div>
<div class="paragraph">
<p><strong>参考:</strong> <a href="https://discuss.gohugo.io/t/live-hugo-site-search-with-lunr-js/2857">Live Hugo Site search with Lunr.js - tips &amp; tricks - Hugo Discussion</a></p>
</div>
<div class="paragraph">
<p>これは lunr.js についての投稿ですが、これによって当初の企画が実現できました。</p>
</div>
<div class="paragraph">
<p>これから実際にインデックスファイルを Hugo を使って書き出す手順を説明します。</p>
</div>
<div class="sect2">
<h3 id="_インデックスファイルのテンプレート">インデックスファイルのテンプレート</h3>
<div class="paragraph">
<p>このインデックスを書き出す Type を "js" と決め、書き出し用テンプレートを <code>layouts/js/single.html</code> に配置しました。</p>
</div>
<div class="listingblock">
<div class="title">single.html</div>
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var data = [{{ range $index, $page := where .Site.Pages "Section" "post"}}
{{ if ne $index 0 }},{{ end }}{
url: "{{ $page.Permalink }}",
title: "{{ $page.Title }}",
content: "{{ .PlainWords }}"
}{{ end }}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Section が Post の投稿に限定して、題名、URL、本文を取り出しています。なお、本文の書き出しには HTML を外すために変数 <code>.PlainWords</code> を使いました。</p>
</div>
<div class="paragraph">
<p><code>.PlainWords</code> の様な Hugo の文書化していないテキストに関する機能と JSON 形式でインデックスファイルを作成する場合のヒントについて <a href="http://rs.luminousspice.com/hugo-site-search/#appendix">遺補</a> にまとめました。</p>
</div>
</div>
<div class="sect2">
<h3 id="_インデックスファイルを生成する空の投稿">インデックスファイルを生成する空の投稿</h3>
<div class="paragraph">
<p>テンプレートで設定した内容を実際に生成するための空の投稿ファイル作ります。Front Matter で　Type を　"js" とし、url を <code>index.js</code> と指定しました。</p>
</div>
<div class="listingblock">
<div class="title">indexjs.adoc</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">---
date: "2016-03-21T14:35:52+09:00"
type: "js"
url: "index.js"
---</code></pre>
</div>
</div>
<div class="paragraph">
<p>このサイトでは AsciiDoc で書いているので拡張子を <code>adoc</code> にしましたが <code>md</code> にしても機能します。</p>
</div>
<div class="paragraph">
<p>その結果が <a href="http://rs.luminousspice.com/index.js" class="bare">http://rs.luminousspice.com/index.js</a> になります。容量は 700 KB です。
インデックスファイルが実利用に耐えうるサイズになるか、当初心配しました。
過去 4 年でこのサイズですから、このサイトではこれから　4−5 年は問題なく使えると判断しました。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_検索ページの作成">検索ページの作成</h2>
<div class="sectionbody">
<div class="paragraph">
<p>次に、作成したインデックスファイル <code>index.js</code> を検索するユーザーインタフェイスを作ります。</p>
</div>
<div class="sect2">
<h3 id="_検索ページテンプレートの作成">検索ページテンプレートの作成</h3>
<div class="paragraph">
<p>検索ページ用の Type "search" のテンプレート <code>layouts/search/single.html</code> を作り、その中にオリジナルの最速インターフェース研究会のスクリプトを取り込みました。</p>
</div>
<div class="paragraph">
<p>収録コンテンツの検索内容との兼ね合いで、オリジナルで使用している JavaScriptによるローマ字仮名変換ライブラリ <code>roma.js</code> は使いませんでした。</p>
</div>
</div>
<div class="sect2">
<h3 id="_検索ページの作成_2">検索ページの作成</h3>
<div class="paragraph">
<p>検索ページを配置するための投稿を作成します。Front Matter は次のように設定しました。Type を "Search" に指定しています。</p>
</div>
<div class="listingblock">
<div class="title">search.adoc (検索ページの Front Matter)</div>
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">---
date: "2016-03-05T21:10:52+01:00"
type:  "search"
url: "search"
title: "全文検索"
---</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>参考:</strong> <a href="https://discuss.gohugo.io/t/another-way-to-search/1736">Another way to search - tips &amp; tricks - Hugo Discussion</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_完成品はこれだ">完成品はこれだ</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="http://rs.luminousspice.com/search/">全文検索</a> が完成品です。</p>
</div>
<div class="paragraph">
<p>矢印キーとリターンキーでページ送りすることができます。
極めて高速に検索でき、自分が抱いていた検索のユーザー体験を破壊してくれました。
複数キーワードを使った複雑な検索などは検索エンジンを使ってもらうことにしましょう。</p>
</div>
<div class="paragraph">
<p>あまりに便利なので、サイト移行の使ったデータ変換作業の検証に実際に使いました。
検索機能を取り付けるまでに必要な作業はここまでです。</p>
</div>
<div class="sect2">
<h3 id="_このサイトでの変更点">このサイトでの変更点</h3>
<div class="paragraph">
<p>オリジナルからの変更点は次の通りです。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>検索結果のページ送りに矢印キーの上下を機能するようにした。</p>
</li>
<li>
<p>レイアウトデザインをテーマに合わせて調整した。</p>
</li>
<li>
<p>サイトの公開形態上、公開日表示を外した。</p>
</li>
<li>
<p>コンテンツの内容から、ローマ字かな変換機能を外した。</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_検索結果の調整">検索結果の調整</h2>
<div class="sectionbody">
<div class="paragraph">
<p>初期設定ではインデックスは公開日順に書き出します。つまり検索結果に複数候補がある時は、日付順に表示します。
このサイトのコンテンツは日記やブログではなく、全てのコンテンツを継続的に更新しているので経時的な順序に意味はありません。
そこで、統計情報のアクセス数や検索キーワード元に重み付けしました。アクセス数の九割を占めている収録コンテンツの半数に <code>.Weight</code> を使って三段階に重み付けしました。</p>
</div>
<div class="paragraph">
<p>検索結果は重み付け＞日付の順に表示するように変えました。</p>
</div>
<div class="paragraph">
<p><strong>参考:</strong> Hugo ドキュメント <a href="https://gohugo.io/templates/list/#ordering-content">Ordering Content</a></p>
</div>
<div class="sect2">
<h3 id="_検索対象の絞り込み">検索対象の絞り込み</h3>
<div class="paragraph">
<p>現在は、全文検索の対象は本文のみになっています。当初は検索対象に、タグや概要も含めていました。実際に完成して使ってみると、全文検索というのは検索キーワードが実際のコンテンツの文脈と一緒に表示されることに意味がある (つまり KWIC なんですが) ことを再確認しました。
そこで、タグや概要については全文検索以外の手段で利用できることから除外しました。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hugo_の検索機能の動向についてのまとめ">Hugo の検索機能の動向についてのまとめ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hugo の検索機能について、一般的に使われている方法について簡単にまとめておきましょう。
今回の事例では極力 JavaScript の追加は制限する方針でしたが、特に制約の状況では、もっと簡単に設置できる方法が見つかります。</p>
</div>
<div class="sect2">
<h3 id="_広く使われている方法">広く使われている方法</h3>
<div class="paragraph">
<p>SSG で広く使われている全文検索機能は <a href="https://github.com/olivernn/lunr.js">lunr.js</a> が有名です。専用のプラグインがある SSG もありますが、Hugo の場合は外部のプログラムによって JSON 形式インデックスファイル生成し、検索するのが一般的なようです。</p>
</div>
<div class="paragraph">
<p>日本語化は、 <a href="https://github.com/MihaiValentin/lunr-languages">lunr-languages</a>を使えばできるらしく、 <a href="http://chasen.org/~taku/software/TinySegmenter/">TinySegmenter</a>
 が同梱されていました。</p>
</div>
<div class="paragraph">
<p><a href="https://www.npmjs.com/package/hugo-lunr">hugo-lunr</a> を使うと Hugo 用のインデックスファイルを生成してくれます。</p>
</div>
</div>
<div class="sect2">
<h3 id="_hugo_での_lunr_js_利用事例">Hugo での lunr.js 利用事例</h3>
<div class="paragraph">
<p>lunr.js の事例は Hugo のサポートサイトで見つかります。検索ページの配置の仕方や、インデックスファイルを作り方は、自分の事例でも参考になりました。</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://discuss.gohugo.io/t/live-hugo-site-search-with-lunr-js/2857">Live Hugo Site search with Lunr.js - tips &amp; tricks - Hugo Discussion</a></p>
</li>
<li>
<p><a href="https://discuss.gohugo.io/t/another-way-to-search/1736">Another way to search - tips &amp; tricks - Hugo Discussion</a></p>
</li>
<li>
<p><a href="https://gist.github.com/sebz/efddfc8fdcb6b480f567">hugo + gruntjs + lunrjs = &lt;3 search</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_今後有望な_docsearch_というサービス">今後有望な DocSearch というサービス</h3>
<div class="paragraph">
<p>この全文検索の作業が一段落して Hugo のリポジトリをアップデートしたところ、Hugo のドキュメントの検索が　Algolia の <a href="http://community.algolia.com/docsearch/">DocSearch</a> というサービスを変更になっていることに気がつきました。</p>
</div>
<div class="paragraph">
<p>自分のサイトの URL を登録すると、クローラーがインデックスを作り、スニペッドで UI を提供してくれるようで、日本語もサポート済みとのこと。</p>
</div>
<div class="paragraph">
<p>具体的な配置方法は、 <a href="https://github.com/spf13/hugo/commit/8890885a705699e7541cfd42f150b37c0a7a72a0">8890885</a> を見ると分かると思います。</p>
</div>
<div class="paragraph">
<p>既に <a href="https://github.com/algolia/algoliasearch-wordpress">WordPress</a> や <a href="https://blog.algolia.com/instant-search-blog-documentation-jekyll-plugin/">Jekyll</a> のプラグインを提供しているようです。</p>
</div>
<div class="paragraph">
<p>これまで、自分でやって来た作業を全て肩代わりしてくれるサービスだ。なんてありがたいと思って試しに登録してみたら、このサイトは "documentation site" ではなく、クローラーも完全には正しく処理できないとお断りされました。
代わりに、10,000 Records、100,000 Operations まで無料で使える Hacker プランを勧められました。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix">遺補</h2>
<div class="sectionbody">
<div class="paragraph">
<p>この作業を行っているうちに見つけた関連項目をまとめます。</p>
</div>
<div class="sect2">
<h3 id="hugofunction">Hugo の文書化されていないテキスト機能</h3>
<div class="paragraph">
<p>Hugo には、いまだ文書化されていないテキストに関する変数や組み込み関数があります。参考までに紹介します。
それぞれの使い方や機能については、GitHub などでコミット内容を確認ください。</p>
</div>
<div class="ulist">
<div class="title">変数</div>
<ul>
<li>
<p>.Plain <a href="https://github.com/spf13/hugo/commit/be5ace1588e54c2b0081d7c8ad57795b67307cde">be5ace1</a></p>
</li>
<li>
<p>.PlainWords <a href="https://github.com/spf13/hugo/commit/f8704c1bf23d22530ff417e0f48ee487a167a0f7">f8704c1</a></p>
</li>
</ul>
</div>
<div class="ulist">
<div class="title">関数 (0.16-DEV から)</div>
<ul>
<li>
<p>plainify <a href="https://github.com/spf13/hugo/commit/e5e1bcc271246fa96ea8ffdb6a8bbc879cf296ce">e5e1bcc</a></p>
</li>
<li>
<p>jsonify <a href="https://github.com/spf13/hugo/commit/435e996c4fd48e9009ffa9f83a19fb55f0777dbd">435e996</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="indexjson">JSON 形式でインデックスファイルを作成するには</h3>
<div class="paragraph">
<p>この記事のアプローチと同じ方法で JSON 形式でインデックファイルを作ることも可能です。実際に XMLHttpRequest で読んで同じように検索できることころまで確認しました。</p>
</div>
<div class="paragraph">
<p>この場合のポイントは、インデックスファイルを書き出す際に、検索対象の文字列を JSON 形式を満足するようにエスケープすることです。Hugo の新しい組み込み関数 <code>jsonify</code> も用意されているのですが、私の事例では全てのコンテンツに対して満足いく結果を出せませんでした。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_まとめ">まとめ</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Hugo からインデックスファイルを書き出すには独自の Type を作る。</p>
</li>
<li>
<p>インデックスファイルのサイズがシステム採用の判断に影響を与える。</p>
</li>
<li>
<p>インデックスファイル内の項目順序が検索結果の表示に影響するので調整が必要。</p>
</li>
<li>
<p>Hugo の文書化されていない機能はユーザーコミュニティの類似の事例から見つけやすい。</p>
</li>
<li>
<p>Hugo の機能拡張をするなら、最新動向を一度調べた方がよい。</p>
</li>
</ul>
</div>
</div>
</div>

  </div>
  <aside class="reference">
  
  
  </aside>
</div>

      <footer>
        <div class="footer">
          &copy; 2020 luminousspice.com.
        </div>
      </footer>
      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

<script>
var addtoc = function() {

  var threshold = 5;
  var toc = document.getElementById('toc');      
  var widget = document.querySelector('.toc');   
  var pre1 = document.querySelector('.sect1');   
  var pre2 = document.querySelector('#preamble');
  var headings = document.querySelectorAll('.post-content h2');
  if (!toc || !widget) {
    return;
  }
  if (headings.length < threshold) {
    return;
  }

  list = [];
  list.push('<div class="toc-title">この記事の内容</div><ol>');

    for (var i=0; i < headings.length; i++) {
      var h = headings[i];
      var d = document.createElement('a');
      var aname = 'i-' + i;
      d.name = aname;
      h.parentNode.insertBefore(d, h);
      var s = '<li><a href="http:\/\/rs.luminousspice.com\/hugo-site-search\/#' + aname + '">' + h.innerHTML + '</a></li>';
      list.push(s);
    }

  list.push('</ol>');
  toc.innerHTML = list.join("");
 
  if (pre2){
    pre2.appendChild(widget);
  } else {
    pre1.parentNode.insertBefore(widget, pre1); 
   }
}

addtoc();
</script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-29141274-4', 'auto');
	
	ga('send', 'pageview');
}
</script>



  </body>
</html>
